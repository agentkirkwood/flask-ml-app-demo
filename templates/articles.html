{% extends 'base.html' %}

{% block title %}Articles Database{% endblock %}

{% block extra_head %}
  <style>
    .article-card {
      transition: box-shadow 0.3s ease;
    }
    .article-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
  </style>
{% endblock %}

{% block content %}
  <div class="my-2">
    <h1>Articles Database</h1>
    <p class="lead">Browse all articles in the training database</p>
  </div>

    <div class="row mb-4">
      <div class="col-lg-8">
        <form method="get" action="/articles" class="d-flex gap-2 flex-wrap">
          <input type="text" name="q" class="form-control" placeholder="Search headlines, body, author, publisher..." value="{{ query_text }}" style="min-width: 220px;">
          <select name="subject" class="form-select" style="max-width: 200px;">
            <option value="">All Subjects</option>
            {% for subject in subjects %}
              <option value="{{ subject }}" {% if subject == subject_filter %}selected{% endif %}>{{ subject }}</option>
            {% endfor %}
          </select>
          <select name="publisher" class="form-select" style="max-width: 200px;">
            <option value="">All Publishers</option>
            {% for publisher in publishers %}
              <option value="{{ publisher }}" {% if publisher == publisher_filter %}selected{% endif %}>{{ publisher }}</option>
            {% endfor %}
          </select>
          <select name="per_page" class="form-select" style="max-width: 140px;">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
          <button type="submit" class="btn btn-primary">Search</button>
          {% if query_text or subject_filter or publisher_filter %}
            <a href="/articles" class="btn btn-outline-secondary">Clear</a>
          {% endif %}
        </form>
      </div>
      <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
        <div class="text-muted">
          Showing <span id="resultsCount">{{ articles|length }}</span> of {{ total }} results
        </div>
      </div>
    </div>
    
    <div class="row" id="articlesContainer"
         data-page="{{ page }}"
         data-total-pages="{{ total_pages }}"
         data-per-page="{{ per_page }}"
         data-query="{{ query_text|e }}"
         data-subject="{{ subject_filter|e }}"
         data-publisher="{{ publisher_filter|e }}">
      {% include 'partials/_article_cards.html' %}
    </div>

    {% if not articles %}
      <div class="row">
        <div class="col-md-12">
          <div class="alert alert-info">
            No articles found in the database.
          </div>
        </div>
      </div>
    {% endif %}

    {% if total_pages > page %}
      <div class="d-flex justify-content-center my-4">
        <button id="loadMoreBtn" class="btn btn-outline-primary">Load more</button>
      </div>
      <div id="loadMoreSentinel" class="mb-4"></div>
    {% endif %}
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      var container = document.getElementById('articlesContainer');
      if (!container) return;

      var loadMoreBtn = document.getElementById('loadMoreBtn');
      var sentinel = document.getElementById('loadMoreSentinel');
      var resultsCount = document.getElementById('resultsCount');

      function updateCount() {
        if (!resultsCount) return;
        var count = container.querySelectorAll('.article-card-item').length;
        resultsCount.textContent = String(count);
      }

      function getParams() {
        return {
          page: parseInt(container.dataset.page || '1', 10),
          totalPages: parseInt(container.dataset.totalPages || '1', 10),
          perPage: container.dataset.perPage || '25',
          query: container.dataset.query || '',
          subject: container.dataset.subject || '',
          publisher: container.dataset.publisher || ''
        };
      }

      function setPage(page) {
        container.dataset.page = String(page);
      }

      function hideLoader() {
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        if (sentinel) sentinel.style.display = 'none';
      }

      function buildUrl(nextPage) {
        var params = new URLSearchParams();
        params.set('page', String(nextPage));
        params.set('per_page', getParams().perPage);
        if (getParams().query) params.set('q', getParams().query);
        if (getParams().subject) params.set('subject', getParams().subject);
        if (getParams().publisher) params.set('publisher', getParams().publisher);
        params.set('partial', '1');
        return '/articles?' + params.toString();
      }

      var isLoading = false;

      function loadMore() {
        if (isLoading) return;
        var params = getParams();
        if (params.page >= params.totalPages) return hideLoader();

        isLoading = true;
        if (loadMoreBtn) loadMoreBtn.disabled = true;

        var nextPage = params.page + 1;

        fetch(buildUrl(nextPage))
          .then(function (response) { return response.text(); })
          .then(function (html) {
            if (!html.trim()) {
              hideLoader();
              return;
            }
            container.insertAdjacentHTML('beforeend', html);
            setPage(nextPage);
            updateCount();

            if (nextPage >= params.totalPages) {
              hideLoader();
            }
          })
          .catch(function () {
            if (loadMoreBtn) loadMoreBtn.disabled = false;
          })
          .finally(function () {
            isLoading = false;
            if (loadMoreBtn) loadMoreBtn.disabled = false;
          });
      }

      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function () {
          loadMore();
        });
      }

      if ('IntersectionObserver' in window && sentinel) {
        var observer = new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) loadMore();
          });
        }, { rootMargin: '200px' });

        observer.observe(sentinel);
      }
    })();
  </script>
{% endblock %}
